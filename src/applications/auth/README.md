# –°–µ—Ä–≤–∏—Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–∞ FastAPI

–≠—Ç–æ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å–æ–¥–µ—Ä–∂–∏—Ç **–º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏**.¬†–ù–∏–∂–µ –ø—Ä–∏–≤–æ–¥–∏—Ç—Å—è –æ–ø–∏—Å–∞–Ω–∏–µ *—Ç–æ–ª—å–∫–æ* —Ç–µ—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤ –∏—Å—Ö–æ–¥–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö:

* [`dependecies.py`](applications/auth/dependecies.py)
  ‚Äë –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è FastAPI (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞, –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –≤–∞–ª–∏–¥–∞—Ü–∏—è —É—á—ë—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö).
* [`schemas.py`](applications/auth/schemas.py)
  ‚Äë Pydantic‚Äë—Å—Ö–µ–º—ã –∑–∞–ø—Ä–æ—Å–æ–≤/–æ—Ç–≤–µ—Ç–æ–≤.
* [`user_service.py`](applications/auth/user_service.py)
  ‚Äë –±–∏–∑–Ω–µ—Å‚Äë–ª–æ–≥–∏–∫–∞ CRUD –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
* [`utils.py`](applications/auth/utils.py)
  ‚Äë —Ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π, —Å–æ–∑–¥–∞–Ω–∏–µ/–ø—Ä–æ–≤–µ—Ä–∫–∞ JWT.
* [`views.py`](applications/auth/views.py)
  ‚Äë HTTP‚Äë—Ä–æ—É—Ç—ã (`/auth/*`).

---

## üì¶ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–∏–∑ `import`‚Äë–æ–≤)

| –ü–∞–∫–µ—Ç             | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                       |
| ----------------- | -------------------------------- |
| **fastapi**       | –í–µ–±‚Äë—Ñ—Ä–µ–π–º–≤–æ—Ä–∫                    |
| **starlette**     | –û—Ç–≤–µ—Ç—ã/–∑–∞–ø—Ä–æ—Å—ã ASGI              |
| **sqlalchemy**    | –ë–î (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π ORM)             |
| **pydantic**      | –°—Ö–µ–º—ã –¥–∞–Ω–Ω—ã—Ö                     |
| **bcrypt**        | –•—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π              |
| **jwt** (`PyJWT`) | –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ JWT‚Äë—Ç–æ–∫–µ–Ω–æ–≤ |

---

## üóÑÔ∏è Pydantic‚Äë—Å—Ö–µ–º—ã

```python
class UserBase:    # –±–∞–∑–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    fullname: str | None
    phone: str | None
    email: EmailStr

class UserCreate(UserBase):
    password1: str  # –ø–∞—Ä–æ–ª—å (–ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏)
    password2: str

class User:        # —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ö–µ–º–∞ (–æ—Ç–≤–µ—Ç—ã API)
    id: int
    created_at: datetime | None
    updated_at: datetime | None
    # + –ø–æ–ª—è –∏–∑ UserBase

class UserLogin:   # —Ñ–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –≤ —Ä–æ—É—Ç–µ—Ä–∞—Ö)
    email: EmailStr
    password: str

class Token:
    access_token: str
    refresh_token: str | None = None  # —Ç–æ–ª—å–∫–æ –ø—Ä–∏ /sign‚Äëin
    token_type: str = "Bearer"
```

---

## üîê –õ–æ–≥–∏–∫–∞ JWT (–∏–∑ `utils.py`)

| –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞           | –ó–Ω–∞—á–µ–Ω–∏–µ     | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                |
| ------------------- | ------------ | ------------------------- |
| `_ACCESS_LIFETIME`  | **1‚ÄØ–º–∏–Ω—É—Ç–∞** | –°—Ä–æ–∫ –∂–∏–∑–Ω–∏ access‚Äë—Ç–æ–∫–µ–Ω–∞  |
| `_REFRESH_LIFETIME` | **7‚ÄØ–¥–Ω–µ–π**   | –°—Ä–æ–∫ –∂–∏–∑–Ω–∏ refresh‚Äë—Ç–æ–∫–µ–Ω–∞ |
| `_ACCESS_TYPE`      | "access"     | –ú–∞—Ä–∫–µ—Ä –≤ payload          |
| `_REFRESH_TYPE`     | "refresh"    | –ú–∞—Ä–∫–µ—Ä –≤ payload          |

–§—É–Ω–∫—Ü–∏–∏:

* `hash_password()`  ¬†‚Äî bcrypt‚Äë—Ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ.
* `verify_password()`¬†‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è.
* `create_access_token(user)` / `create_refresh_token(user)`¬†‚Äî —Å–æ–∑–¥–∞—é—Ç —Ç–æ–∫–µ–Ω—ã —Å –ø–æ–ª—è–º–∏ `sub` (email) –∏, –¥–ª—è access, `id`.
* `decode_jwt(token)`¬†‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ.

–ö–ª—é—á –∏ –∞–ª–≥–æ—Ä–∏—Ç–º –±–µ—Ä—É—Ç—Å—è –∏–∑ `core.conf.settings`¬†(`settings.secret_key`, `settings.algorithm`).

---

## üñ•Ô∏è HTTP‚Äë—Ä–æ—É—Ç—ã (–∏–∑ `views.py`)

| –ú–µ—Ç–æ–¥    | –ü—É—Ç—å            | –¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞                               | –û—Ç–≤–µ—Ç                                | –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                                                                              |
| -------- | --------------- | ------------------------------------------ | ------------------------------------ | -------------------------------------------------------------------------------------------------------- |
| **POST** | `/auth/sign-up` | `UserCreate` (JSON)                        | `User`                               | –°–æ–∑–¥–∞—ë—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ `password1/password2`.                                        |
| **POST** | `/auth/sign-in` | `username` + `password` (form‚Äëurl‚Äëencoded) | `Token` (—Ç–æ–ª—å–∫–æ `access_token`)      | *–°—Ç–∞–≤–∏—Ç* cookie `refresh_token` (HttpOnly, Secure). –í –∑–∞–≥–æ–ª–æ–≤–∫–µ –æ—Ç–≤–µ—Ç–∞ `Authorization: Bearer <access>`. |
| **POST** | `/auth/refresh` | ‚Äì                                          | `Token` (–æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π `access_token`) | –ë–µ—Ä—ë—Ç refresh‚Äë—Ç–æ–∫–µ–Ω –∏–∑ cookies, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–æ–≤—ã–π access. –ó–∞–≥–æ–ª–æ–≤–æ–∫ `Authorization` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è.          |
| **POST** | `/auth/logout`  | ‚Äì                                          | `{ "success": true }`                | –£–¥–∞–ª—è–µ—Ç cookie `refresh_token`.                                                                          |
| **GET**  | `/auth/auth/me` | ‚Äì                                          | `User`                               | –¢—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–≥–æ–ª–æ–≤–æ–∫ `Authorization: Bearer <access>`.                                                    |

---

## üîÑ –î–∏–∞–≥—Ä–∞–º–º–∞ –æ–±–º–µ–Ω–∞ (–∫—Ä–∞—Ç–∫–æ)

1. **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è** ‚Üí access‚Äë—Ç–æ–∫–µ–Ω –Ω–µ –≤—ã–¥–∞—ë—Ç—Å—è.
2. **–í—Ö–æ–¥** ‚Üí `access_token` (–≤ —Ç–µ–ª–µ + –∑–∞–≥–æ–ª–æ–≤–∫–µ), `refresh_token` (cookie).
3. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞** ‚Üí –Ω–æ–≤—ã–π `access_token`; refresh‚Äëcookie –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è.
4. **–í—ã—Ö–æ–¥** ‚Üí refresh‚Äëcookie —É–¥–∞–ª—è–µ—Ç—Å—è; access‚Äë—Ç–æ–∫–µ–Ω –∫–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å—Ç–æ –∑–∞–±—ã–≤–∞–µ—Ç.

---

## üóÉÔ∏è –°–µ—Ä–≤–∏—Å—ã –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

| –§–∞–π–ª              | –ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ / –∫–ª–∞—Å—Å—ã                                                            |
| ----------------- | ------------------------------------------------------------------------------------ |
| `dependecies.py`  | `validate_auth_user`, `get_current_user`, `get_current_user_for_refresh_from_cookie` |
| `user_service.py` | `UserAuthService.create()`, `UserAuthService.get_user()`                             |
| `utils.py`        | –•—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è/–ø—Ä–æ–≤–µ—Ä–∫–∞ JWT                                                  |

`validate_auth_user` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:

* —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ email;
* —Ñ–ª–∞–≥ `is_active` –º–æ–¥–µ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è;
* –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ø–∞—Ä–æ–ª—è (`verify_password`).

–ü—Ä–∏ –Ω–µ—É–¥–∞—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–æ–¥–Ω–∏–º–∞—é—Ç—Å—è `HTTPException` —Å–æ —Å—Ç–∞—Ç—É—Å–∞–º–∏ 400/401/404.

---
